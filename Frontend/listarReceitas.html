<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Receitas</title>
    <link rel="stylesheet" href="CSS/style.css" />
    <link rel="stylesheet" href="CSS/styleReceitas.css" />
  </head>
  <body>
 <header>
       <div class="logo">
            <img src="IMG/chefs-delight-restaurant-logo_11024933.png!sw800" alt="">
       </div>
       <div class="titulos">
            <div  class="titulo">
                <p>QUASETUDO</p>
            </div>
            <div class="titulo2">
                <p>
                    GOSTOSO
                </p>
            </div>
       </div>
       <div class="icone-usuario">
            <a href="perfil.html"><img src="IMG/4092564-about-mobile-ui-profile-ui-user-website_114033.png" alt=""></a>
       </div>
   </header>

  <main>
  <div class="nav">
            <ul>
                  <li>
                    <a href="index.php">Home</a>
                </li>

                <li>
                    <a href="listarReceitas.html">Todas as Receitas</a>
                </li>
                <li>
                    <a href="cadastroReceita.html">Nova Receita</a>
                </li>
                <li>
                    <a href="listarReceitas.html">Receitas</a>
                </li>
               
                <li>
                    <a href="refeicao.html">Refeição</a>
                </li>
                
                </li>
                <li>
                    <a href="usuarios.html">Chefs</a>
                </li>
                  <li>
                    <a href="sobre.html">Sobre</a>
                </li>
            </ul>
        </div>

      <section class="receitas-topo">
        <h2>Receitas</h2>
        <p class="receitas-desc">
          Explore nossas receitas: fotos, tempo de preparo, nível de dificuldade
          e uma breve descrição.
        </p>

        <div class="filtro-categoria">
          <select name="" id="lista-filto">
  
          </select>
          <button onclick="addCategoria()">Adicionar Categoria</button>
        </div>

      </section>

      <section id="lista-receitas" class="lista-receitas">
        <!-- 
        
        <article class="receita-card">
          <div class="card-img" id="card-img">
            <img src="IMG/Frango-assado-com-ervas.jpg" alt="Receita 1" />
          </div>
          <div class="recei_info">
            <h3 class="receita-titulo">Frango Assado com Ervas</h3>
            <p class="receita-resumo">
              Frango suculento temperado com ervas frescas e assado até dourar,
              acompanha arroz e salada.
            </p>
            <div class="receita-meta">
              <span>Tempo: 1h 15min</span>
              <span>Dificuldade: Média</span>
            </div>
            <div class="receita-actions">
              <a class="ver-receita" href="receita-detalhe.html?">Ver receita</a>
              <span class="tag">Carnes</span>
            </div>
          </div>
        </article>

        -->
      </section>
    </main>

    <footer>
      <div>Copyright</div>
    </footer>
    <script>

        const listaReceitas = document.getElementById('lista-receitas');
        var listafiltro = document.getElementById('lista-filto');


        //Criando articles DOM
        fetch("../Backend/buscar_receitas.php")
            .then(response => response.json())
            .then(recei => {
                console.log(recei);
                for (let i = 0; i < recei.receitas.length; i++){

                   let article = document.createElement('article')
                   article.className = "receita-card";
                   let divImg = document.createElement('div')
                   divImg.className = "card-img";
                   let Img = document.createElement('img')
                   Img.src = "../Backend/buscar_imagem.php?id="+recei.receitas[i].idreceita;
                   console.log(Img.src);
                   let divReceInfo = document.createElement('div')
                   divReceInfo.className = "recei_info";
                   let h3Titulo = document.createElement('h3')
                   h3Titulo.className = "receita-titulo";
                   let paraResumo = document.createElement('p')
                   paraResumo.className = "receita-resumo";
                   let divReceMeta = document.createElement('div')
                   divReceMeta.className = "receita-meta";
                   let spanTempo = document.createElement('span')
                   spanTempo.textContent = "Tempo: 1h 15min";
                   let spanDifi = document.createElement('span')
                   spanDifi.textContent = "Dificuldade: Média";
                   let divReceAct = document.createElement('div')
                   divReceAct.className = "receita-actions";
                   let linkReceita = document.createElement('a')
                   linkReceita.className = "ver-receita";
                   let spanCategoria = document.createElement('span')
                   spanCategoria.className = "tag";

                   h3Titulo.textContent = recei.receitas[i].titulo;
                   paraResumo.textContent = recei.receitas[i].descricao;
                   for (let j = 0; j < recei.CategoriasReceitas.length; j++){
                     if(recei.receitas[i].idreceita == recei.CategoriasReceitas[j].receita_idreceita){
                        spanCategoria.textContent = recei.CategoriasReceitas[j].categoria;
                        break;
                     }
                   }
                   //spanCategoria.textContent = "Bolos"
                   linkReceita.textContent = "ver receita";
                   linkReceita.href = "../Frontend/receita.html";

                   divReceAct.appendChild(linkReceita);
                   divReceAct.appendChild(spanCategoria);

                   divReceMeta.appendChild(spanTempo);
                   divReceMeta.appendChild(spanDifi);

                   divReceInfo.appendChild(h3Titulo);
                   divReceInfo.appendChild(paraResumo);
                   divReceInfo.appendChild(divReceMeta);
                   divReceInfo.appendChild(divReceAct);

                   divImg.appendChild(Img);

                   article.appendChild(divImg);
                   article.appendChild(divReceInfo);

                   listaReceitas.appendChild(article);

                }

        })
        .catch(error => console.error("Erro:", error));

        listafiltro = document.getElementById('lista-filto');
        let zero = document.createElement('option');
        zero.textContent = "";
        listafiltro.appendChild(zero);
        fetch("../Backend/buscar_categorias.php")
            .then(response => response.json())
            .then(dados => {

                for (let i = 0; i < dados.length; i++){
                    var option = document.createElement('option');
                    option.textContent = dados[i].categoria;
                    listafiltro.appendChild(option);
                }

        })
        .catch(error => console.error("Erro:", error));

        
        function addCategoria(){

            var novaCategoria = prompt("Insira o nome da nova categoria: ");

            if(!novaCategoria){
                console.log("Insira uma categoria corretamente");
                return;
            }else{

                const formData = new FormData();
                formData.append("categoria", novaCategoria);
                formData.append("ativo", 1);


                fetch("../Backend/cadastrar_categoria.php", {
                    method: "POST",
                    body: formData
                })
                .then(res => res.text())
                .then(res => {
                    alert(res); // mostra resposta do PHP
                })
                .catch(err => console.error("Erro:", err));
            }

           while (listafiltro.options.length > 0){
            listafiltro.remove(0)
           }
         
             let zero = document.createElement('option');
             zero.textContent = "";
             listafiltro.appendChild(zero);
             fetch("../Backend/buscar_categorias.php")
                .then(response => response.json())
                .then(dados => {

                    for (let i = 0; i < dados.length; i++){
                        var option = document.createElement('option');
                        option.textContent = dados[i].categoria;
                        listafiltro.appendChild(option);
                    }

            })
            .catch(error => console.error("Erro:", error));

        }

         listafiltro.addEventListener('change', filtrarCategoria);

        function filtrarCategoria(){

            listafiltro = document.getElementById('lista-filto');

            listaReceitas.innerHTML = "";

            const categoriaSelect = listafiltro.options[listafiltro.selectedIndex].text;

            //const url = "../Backend/buscar_receitas.php?categoria="+ encodeURIComponent(categoriaSelect);

            fetch("../Backend/buscar_receitas.php")
            .then(response => response.json())
            .then(recei => {
                console.log(recei);
                for (let i = 0; i < recei.receitas.length; i++){

                  var categoriaTitulo;

                  for (let j = 0; j < recei.CategoriasReceitas.length; j++){
                     if(recei.receitas[i].idreceita == recei.CategoriasReceitas[j].receita_idreceita){
                        categoriaTitulo = recei.CategoriasReceitas[j].categoria;
                        break;
                     }
                   }

                   if(categoriaTitulo === categoriaSelect){
                      /*let article = document.createElement('article');
                      article.className = "receita-card";
                      article.dataset.id = recei.receitas[i].idreceita;
                      article.dataset.titulo = recei.receitas[i].titulo;
                      article.dataset.resumo = recei.receitas[i].descricao;
                      let divImg = document.createElement('div');
                      divImg.className = "card-img";
                      let Img = document.createElement('img');
                      Img.src = "IMG/Frango-assado-com-ervas.jpg";
                      let divReceInfo = document.createElement('div');
                      divReceInfo.className = "recei_info";
                      let h3Titulo = document.createElement('h3');
                      h3Titulo.className = "receita-titulo";
                      let paraResumo = document.createElement('p');
                      paraResumo.className = "receita-resumo";
                      let divReceMeta = document.createElement('div');
                      divReceMeta.className = "receita-meta";
                      let spanTempo = document.createElement('span');
                      spanTempo.textContent = "Tempo: 1h 15min";
                      let spanDifi = document.createElement('span');
                      spanDifi.textContent = "Dificuldade: Média";
                      let divReceAct = document.createElement('div');
                      divReceAct.className = "receita-actions";
                      let buttonReceita = document.createElement('button');
                      buttonReceita.className = "selecionar-receita ver-receita";
                      buttonReceita.type = "button";
                      let spanCategoria = document.createElement('span');
                      spanCategoria.className = "tag";

                      h3Titulo.textContent = recei.receitas[i].titulo;
                      paraResumo.textContent = recei.receitas[i].descricao;
                  
                      spanCategoria.textContent = categoriaTitulo;
                      buttonReceita.textContent = "Selecionar Receita";

                      divReceAct.appendChild(buttonReceita);
                      divReceAct.appendChild(spanCategoria);

                      divReceMeta.appendChild(spanTempo);
                      divReceMeta.appendChild(spanDifi);

                      divReceInfo.appendChild(h3Titulo);
                      divReceInfo.appendChild(paraResumo);
                      divReceInfo.appendChild(divReceMeta);
                      divReceInfo.appendChild(divReceAct);

                      divImg.appendChild(Img);

                      article.appendChild(divImg);
                      article.appendChild(divReceInfo);

                      listaReceitas.appendChild(article);*/

                  let article = document.createElement('article')
                   article.className = "receita-card";
                   let divImg = document.createElement('div')
                   divImg.className = "card-img";
                   let Img = document.createElement('img')
                   Img.src = "../Backend/buscar_imagem.php?id="+recei.receitas[i].idreceita;
                   console.log(Img.src);
                   let divReceInfo = document.createElement('div')
                   divReceInfo.className = "recei_info";
                   let h3Titulo = document.createElement('h3')
                   h3Titulo.className = "receita-titulo";
                   let paraResumo = document.createElement('p')
                   paraResumo.className = "receita-resumo";
                   let divReceMeta = document.createElement('div')
                   divReceMeta.className = "receita-meta";
                   let spanTempo = document.createElement('span')
                   spanTempo.textContent = "Tempo: 1h 15min";
                   let spanDifi = document.createElement('span')
                   spanDifi.textContent = "Dificuldade: Média";
                   let divReceAct = document.createElement('div')
                   divReceAct.className = "receita-actions";
                   let linkReceita = document.createElement('a')
                   linkReceita.className = "ver-receita";
                   let spanCategoria = document.createElement('span')
                   spanCategoria.className = "tag";

                   h3Titulo.textContent = recei.receitas[i].titulo;
                   paraResumo.textContent = recei.receitas[i].descricao;
                   for (let j = 0; j < recei.CategoriasReceitas.length; j++){
                     if(recei.receitas[i].idreceita == recei.CategoriasReceitas[j].receita_idreceita){
                        spanCategoria.textContent = recei.CategoriasReceitas[j].categoria;
                        break;
                     }
                   }
                   //spanCategoria.textContent = "Bolos"
                   linkReceita.textContent = "ver receita";
                   linkReceita.href = "../Frontend/receita.html";

                   divReceAct.appendChild(linkReceita);
                   divReceAct.appendChild(spanCategoria);

                   divReceMeta.appendChild(spanTempo);
                   divReceMeta.appendChild(spanDifi);

                   divReceInfo.appendChild(h3Titulo);
                   divReceInfo.appendChild(paraResumo);
                   divReceInfo.appendChild(divReceMeta);
                   divReceInfo.appendChild(divReceAct);

                   divImg.appendChild(Img);

                   article.appendChild(divImg);
                   article.appendChild(divReceInfo);

                   listaReceitas.appendChild(article);

                   }

                 

                }

          })
          .catch(error => console.error("Erro:", error));

          listafiltro.innerHTML = "";
          let zero = document.createElement('option');
          zero.textContent = "";
          listafiltro.appendChild(zero);
          fetch("../Backend/buscar_categorias.php")
              .then(response => response.json())
              .then(dados => {

                  for (let i = 0; i < dados.length; i++){
                      var option = document.createElement('option');
                      option.textContent = dados[i].categoria;
                      listafiltro.appendChild(option);
                  }

          })
          .catch(error => console.error("Erro:", error));

        }
        window.filtrarCategoria = filtrarCategoria;

    </script>
  </body>
</html>
